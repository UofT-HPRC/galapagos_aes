# Hardware Project

This folder contains the required IP cores as well as tcl files to generate the full Vivado project. 
We used `Vivado 2019.1` to program `Xilinx Sidewinder` boards (xczu19egffvc1760-2-i).

# Contents

`constraints` includes a constraint file for the board we used. 

`ipdefs` includes required Galapagos IP cores and user-defined IP cores. 
You can find all the Galapagos-required IP cores under the `ipdefs/galapagos_ipdefs` folder.
In our case, you can find the AES encryption/decryption IP cores generated by Vivado HLS 2019.1 under the `ipdefs/user_ipdefs`.

`sources` includes two files that are required in order to generate the Vivado project. 
The `ip.coe` is the one that you should be aware of it most and will need to modify it later for your projects.

`build.tcl` is the primary tcl file to generate the Vivado project.

# How to Compile

1- You have to open Vivado under the `hardware` path folder because `build.tcl` used relative addresses to find IP cores.

2- Before sourcing tcl files, you have to modify two lines in `build.tcl` based on wherever you have cloned your project. 
Open `build.tcl` and search for `ip.coe`. 
You will find that at lines `455` and `812`, we used absolute path.
You have to modify these lines to correct the absolute path on your local machine. 

3- Then, when Vivado came up, go to the `Tools` and click `Run Tcl Script...`. 
Select `build.tcl` and compile it.
It might take seconds or minutes to ultimately create the project, including the block design. 

<img src="https://github.com/UofT-HPRC/galapagos_aes/blob/main/hardware/PNGs/read_tcl.png" width="600"/>

4- Search for `IP INTEGRATOR` under `Flow Navigator`, click `Open Block Design`, and open `pr.bd`.
You don't have anything to do with `shell.bd` unless you were curious about it.

When the diagram came up, double click on the `network` block and go inside that block.
In order to compile and successfully run this project, you have to modify three configurations in this diagram.

4.1- Double click on `GULF_Stream_0`, and you will see it has four parameters that you should set based on the ip addresses that you use.
The ip address that you set here is being used for this FPGA. 
It makes current FPGA accessible by other either FPGAs or CPUs. 
You can use any MAC address you want, but I suggest modifying only 8 LSB bits.

P.S: Any questions regarding `Gulf-Stream` should be asked from Clark who developed this UDP bridge.
This is the main GitHub repo of `Gulf-Stream`: https://github.com/UofT-HPRC/GULF-Stream.git

<img src="https://github.com/UofT-HPRC/galapagos_aes/blob/main/hardware/PNGs/gulf_stream.png" width="600"/>

4.2- Double click on `ip_constant_block_inst` and modify all four parameters. 
These parameters should be the same as what you configured in the previous step (4.1).
One thing you should notice here is that `IP Address` should be filled in reverse order. 
For instance, in the picture below, the address I used was `10.1.5.8`, so I filled it in reverse like `8.5.1.10`.
Other fields should be filled as always.

<img src="https://github.com/UofT-HPRC/galapagos_aes/blob/main/hardware/PNGs/ip_constant_block.png" width="600"/>

4.3- Double click on `blk_mem_gen_0`, go to the other options, and click `Edit` to edit the Coe file.
You have to add all the ip addresses you use for Galapagos kernels you have in your project.
For the purpose of the Coe file, you have to write the ip addresses in decimal rather than ipv4 format. 
For the conversion between decimal and ipv4 formats, you can use online websites.

- decimal to ipv4: https://www.browserling.com/tools/dec-to-ip
- ipv4 to decimal: https://www.ipaddressguide.com/ip 

For instance, in our project, we had five kernels, three on CPU and two on FPGA. 
For the kernels on CPU, we used ip address `10.1.2.101`, which is equal to `167838309` in decimal. 
For the kernels on FPGA, we used ip address `10.1.5.8`, which is equal to `167838984` in decimal.
Also, it is worth mentioning that you have to separate different ip addresses by writing three 0s like what we did in our example `0 0 0`. 
Finally, save the file.

<img src="https://github.com/UofT-HPRC/galapagos_aes/blob/main/hardware/PNGs/ip.coe.png" width="600"/>

5- By now, after modifying all the things explained above, you should be ready to generate the bitstreams.
To do so, click the `Generate Bitstream`.
While I was testing the tcl files, I noticed that you might not be able to generate the bitstream on the first try.
You might encounter an error saying you have to compile your `sandbox`.
I just ignored the first try errors and recompiled the project, and it did work. 
I think you can also do this, and you should be okay (fingers crossed :D).

6- If your project is compiled without error, you're done. 
It might take hours to complete the compilation and generate the bitstream.

# How to Program the Board (PC Group Members Only)

This is only for PC group members who have access to the agents and mpsocs. 

You can find the generated bitstream file at `aes_proj/aes_proj.runs/impl_1/`.
I set the settings to generate the `.bin` file as well as `.bit` file. 
Using `.bin` is much faster than the latter to program the board. 
You should be able to see one or both of the `shellTop.bit` and `shellTop.bin` files.
If not, go through the above steps again and see where the problem is.

You have to `scp` the bitstream to the mpsoc you are using. We used mpsoc 8, so here are the steps:

1- `scp shellTop.bin savi@10.10.14.208:/home/savi/`. 
By this command, you will have the bitstream on your mpsoc.
Notice that `208` means mpsoc 8; if you are using other mpsocs like mpsoc 13, the number should be `213`.

2- SSH to your mpsoc and find the bitstream. 
Then run `sudo mv shellTop.bin /lib/firmware/` and `cd /lib/firmware/`.

3- Finally, to program the board, you should run `sudo program shellTop.bin` and YAAAY.
You are done. 
Your mpsoc is programmed successfully.

# How to Debug (PC Group Members Only)

This is only for PC group members who have access to the agents and mpsocs.

You might want to debug the programmed project on mpsocs. 
You may have noticed that in the project we provided, there are several ILAs configured to enable the debugging on mpsocs.
You can get rid of these ILAs or add more ILAs if you want without any concern. 
We just put them for educational purposes.

Follow the below steps for debugging:

1- On mpsocs, after running `sudo program shellTop.bin` run `xvcserver -d`.
This will send the ILA results to the network, which is observable within your Vivado project.

2- On the Vivado project, under `PROGRAM AND DEBUG`, click on `Open Hardware Manager`. 
This is the place that is similar to ModelSim, and you would be able to see the waves.

3- On the `Tcl Console` (at the bottom of the window), you should run a couple of commands.

3.1- `connect_hw_server`.

3.2- `open_hw_target -xvc_url 10.10.14.208:2542`.
Be aware that if you are using other mpsoc you should modify the `208` to the appropriate number.

4- You have to again run the commands in step 1. 
Then, after Vivado did the refreshing process, you would be able to see ILAs.

P.S: For debugging purposes, we asked Camilo to help us. 
If you have any questions in this regard, feel free to message him.

# How to Create Your Project

To create your own project, you have to do all the modifications we mentioned above, like configuring the communication ip addresses and so on.
To add your IP cores to the project, open `pr.bd` again, go inside the `applicationRegion`. 
You will see that we have two `enc` and `dec` cores over there sandwiched by two input/output FIFOs. 
You can add your IP cores here as well; just remember to add the FIFOs at the input/output of your cores.
Also, you might need to modify the `input_switch` and `output_switch` based on the number of kernels you have in your project.
Other than those, you should be okay, and you can do the compiling process again and work on your own project.